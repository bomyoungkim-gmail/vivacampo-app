# Internal Changelog

> For humans. Keep it factual. Link PRs if available.

## Unreleased
- Addressed `datetime.utcnow()` deprecation by switching to timezone-aware `datetime.now(timezone.utc)` across code/tests.
- Bumped `python-multipart` and `planetary-computer` minimum versions to reduce deprecation warnings.
- Added `created_by_user_id` to farm API responses for ownership-aware UI.
- Added Settings page with member invite flow and members list in app-ui.
- Added role-based UI guards for farm create/delete actions and ownership badge in farm list.
- Added unit tests for auth signup/login use cases.
- Pinned `bcrypt<4` to restore passlib compatibility in API container.
- Fixed tenant creation to serialize `quotas` JSON when inserting into `jsonb`.
- Added AOI geometry normalization (make valid + simplify), reject invalid geometry with 422, and repository unit tests.
- Added AOI split simulation endpoint (voronoi/grid) with spatial repository support and unit test.
- Added AOI split create endpoint to persist child AOIs with parent linkage and optional backfill enqueue.
- Added split batch idempotency (Idempotency-Key + split_batches) to prevent duplicate child AOIs.
- Added AOI status endpoint for polling processing state by AOI.
- Added field calibration endpoints and calibration regression use case.
- Added versioned field calibrations with single active record per date/metric.
- Added prediction endpoint backed by yield_forecasts with tenant-average fallback.
- Added unit conversion to normalize sc/ha into kg/ha (default).
- Added calibration audit log and Prometheus counter for calibration submissions.
- Added field feedback endpoint and persistence for issue/false positive logging.
- Added SRRE (Simple Ratio Red Edge) vegetation index to TiTiler expressions.
- Added DETECT_HARVEST worker job to create HARVEST_DETECTED signals from RVI drops.
- Added nitrogen status API use case and router (SRRE zone map support).
- Added correlation API use case and router for vigor/climate insights.
- Added radar fallback tooltip and dot styling for NDVI chart when NDVI is missing but RVI is present.
- Added NitrogenAlert component and wired it into AOI Overview.
- Added Analysis tab with correlation chart and insights panel.
- Added GitHub Actions workflows for staging/prod deploys and a test placeholder.
- Added Terraform scaffold for staging/production (ECS, RDS, S3, SQS modules).
- Added Cloudflare intelligence cache worker for nitrogen/correlation endpoints.
- Added year-over-year correlation endpoint and UI chart for season comparison.
- Added productivity score card based on NDVI average and radar mode badge on map.
- Removed non-existent `rio-tiler-stac` dependency from TiTiler requirements to fix Docker build.
- Added missing shadcn `Alert` component to resolve NitrogenAlert import.
- Auto-backfill now triggers on AOI creation (last 8 weeks).
- Backfill now enqueues PROCESS_RADAR_WEEK, PROCESS_WEATHER, and PROCESS_TOPOGRAPHY.
- Worker job handlers mark status as RUNNING at start.
- Added STAC/Open-Meteo request/response logging for data acquisition visibility.
- Added admin endpoint to enqueue backfills for AOIs without derived assets.
- Added Admin UI action to trigger reprocess of AOIs without data.
- Fixed SQS client usage in admin reprocess and AOI backfill dispatch.
- Fixed admin_ui dev host binding and port mapping to make /admin reachable on localhost:3001.
- Fixed admin UI routes to avoid double basePath (/admin/admin/*).
- Admin jobs list now shows `aoi_id` and `job_key`.
- Admin jobs list now shows farm and AOI names; filters use DONE status.
- Added `aiohttp` to worker dependencies.
- Fixed admin jobs filtering to use jobs table alias with joins.
- Fixed process_weather status update to avoid non-existent error_message column.
- Jobs filter label normalized to DONE; weather end_date is clamped to today for Open-Meteo.
- Added jobs.error_message migration and surfaced errors in Admin Jobs UI.
- Fixed PROCESS_WEATHER to handle AOI geometry as GeoJSON (prevents TypeError).
- Added admin endpoints to list missing weeks and reprocess missing weeks.
- Added Admin UI page for missing weeks with reprocess action.
- Increased worker throughput with configurable concurrency and batch receive.
- **Dynamic Tiling + MosaicJSON (ADR-0007)**:
  - TiTiler updated with titiler-mosaic, MosaicTilerFactory, and STAC-mosaic endpoints
  - Added `/stac-mosaic/tiles` endpoint for multi-band vegetation indices (NDVI, NDRE, NDWI, etc.)
  - MosaicJSON stores unsigned STAC item URLs; signing at request time via pystac.sign_inplace()
  - Added CREATE_MOSAIC job for weekly MosaicJSON generation (Brazil-wide Sentinel-2)
  - Added CALCULATE_STATS and WARM_CACHE worker jobs
  - Added tiles_router.py with authenticated tile endpoints and TileJSON for GIS integration
  - Migration 004_add_mosaic_registry.sql for mosaic tracking
  - Full pipeline tested: Auth → API → TiTiler → MosaicJSON → STAC → Planetary Computer → PNG
  - Expected storage savings: ~99.9% (~2.5MB vs ~2.6TB/year)
- **UI/UX Improvements (2026-02-04)**:
  - Admin-UI: Implemented dark mode with ThemeToggle component (localStorage + system preference detection)
  - Admin-UI: Refactored globals.css with WCAG AA accessible colors (HSL system, 4.5:1 contrast)
  - Admin-UI: Updated tailwind.config.js with chart colors, aspect-ratio utilities, touch targets (44px)
  - Admin-UI: Implemented mobile-first design in all 4 pages (dashboard, audit, jobs, tenants)
  - Admin-UI: Added interactive states (.interactive-card, .table-row-interactive)
  - App-UI: Added aspect-ratio wrappers to Charts.tsx to eliminate horizontal scroll
  - App-UI: Improved dark mode contrast (muted-foreground: 65.1% → 70%)
  - App-UI: Added dark mode support to chart components

## 2026-02-05
- Added hexagonal domain foundation (Pydantic base classes, value objects, Farm/AOI entities).
- Added domain ports (message queue, object storage, farm repository) and worker domain scaffolding.
- Added unit tests for domain entities and value objects.
- Added infrastructure adapters for SQS and S3 (API) and satellite providers (worker).
- Added resilient satellite adapter with fallback chain and validation of external payloads.
- Added local queue and local filesystem adapters for dev/testing.
- Added in-memory satellite cache adapter.
- Added circuit breaker usage for SQS/S3 adapters and resilient satellite adapter.
- Added unit tests for satellite adapters and local adapters.
- Added application DTOs/use cases for farms and SQLAlchemy farm repository adapter.
- Updated farms router to use use cases/DTOs.
- Added unit tests for farm use cases.
- Added AOI DTOs/use cases and SQLAlchemy AOI repository adapter.
- Updated AOI router (create/list) to use use cases/DTOs.
- Added signal DTOs/use cases and SQLAlchemy signal repository adapter.
- Updated signals router to use use cases/DTOs.
- Added job DTOs/use cases and SQLAlchemy job repository adapter.
- Updated jobs router to use use cases/DTOs.
- Added correlation/nitrogen DTOs, use cases, and SQLAlchemy adapters.
- Updated correlation and nitrogen routers to use use cases/DTOs.
- Added unit tests for AOI, signal, job, correlation, and nitrogen use cases.
- Added DI containers for API/worker and basic container tests.
- Wired API routers to resolve use cases through DI container.
- Refactored AOI auto-backfill to use RequestBackfill use case (no direct SQL in router).
- Added radar and weather data repository ports/adapters plus use cases.
- Updated radar and weather routers to use use cases/DTOs.
- Added weather sync job creation to job repository adapter.
- Added unit tests for radar and weather use cases.
- Refactored tiles router to use use cases and spatial repository (removed direct SQL/S3 usage).
- Added AOI spatial repository and tile use cases/config.
- Added system admin, tenant admin, and AI assistant repositories and use cases.
- Updated system admin, tenant admin, and AI assistant routers to use use cases.
- Added unit tests for tiles, system admin, tenant admin, and AI assistant use cases.
- Refactored farms geocoding endpoint to use geocoding use case + Nominatim adapter.
- Added geocoding port/adapter/use case and unit test.
- Standardized HTTP and validation error responses to contract shape via exception handlers.
- Added error handler tests.
- Added request ID middleware with traceId propagation in error responses.
- Standardized rate limit handler error shape (429) and added OpenAPI error schema + per-route error docs.
- Added `get_current_tenant_id` dependency and applied it to multi-tenant routers.

## 2026-02-06
- Removed fallback tiling path in app-ui (`DynamicTileLayer` + removed tile prop map constant).
- Removed prior COG pipeline from worker `process_week` and forced dynamic tiling path.
- Added migration plan and SQL for tenant query composite indexes (jobs, aois, opportunity_signals).
- Added Hypothesis (dev dependency) and property-based tests for domain value objects.
- Added OpenTelemetry tracing setup (API) and dependencies.
- Documented API DI container usage in `di_container.py`.
- Rate limiting now uses tenant_id when available (fallback to IP).
- Observability now tolerates missing OpenTelemetry packages (skips tracing).
- Enabled OpenTelemetry by default (console exporter if no endpoint configured).
- Data provider resilience: new provider interfaces, index calculator + tests, and provider registry with fallback chain + metrics.
- Added Planetary Computer, AWS Earth Search, and CDSE providers; migrated topography/radar/weather/mosaic adapters to provider registry.
- Added STAC scene cache (migration + repository) and cached provider wrapper.
- Added admin endpoints: `/admin/providers/status` and `/admin/jobs/reprocess`.
- Removed worker `stac_client.py` after migrating all references.
- Fixed SQLAlchemy repository initialization and `_execute_query` handling of TextClause.
- Fixed OIDC login to reuse existing Identity by email and handle unique constraint conflicts.

## 2026-02-04
- Added LocalStack custom build + init script for SQS queue bootstrap
- Added/updated P0 RBAC regression tests and Windows-friendly DB host override
- Fixed vision-service router exception handler registration
- Presigned S3 asset URLs in AOI/radar responses to avoid exposing raw S3 URIs

## 2026-02-03
- Initialized template pack (AI Scaffolding)
